# Cubox Saver 更新日志

## v5.0 (2024) - 官方标准版本 🆕

### 🚀 重大重写
- **基于官方文档完全重写**：遵循 [PopClip 官方文档](https://www.popclip.app/dev/js-actions) 规范
- **采用标准实现方式**：脚本入口点位于文件顶层，符合 PopClip 执行模型
- **移除所有非标准代码**：清理所有函数定义和兼容性代码
- **标准 API 调用**：使用 `popclip.input.text` 和 `popclip.options`

### 🔧 核心改进
- **顶层执行模式**：代码直接在文件顶层执行，让 PopClip 自动包装
- **标准数据访问**：通过 `popclip` 全局对象获取输入和配置
- **配置文件标准化**：使用 `"javascript file"` 字段
- **插件标识符更新**：`cc.cubox.popclip.saver.v5.0`

### ✅ 彻底解决的问题
- ✅ 所有 "Can't find variable" 错误（根本性解决）
- ✅ JavaScript 执行环境兼容性问题
- ✅ 函数定义与调用时机冲突
- ✅ 参数传递方式错误
- ✅ 非标准实现导致的各种问题

### 📋 技术优势
- **官方标准实现**：完全符合 PopClip 开发规范
- **简洁高效**：移除冗余的兼容性代码
- **稳定可靠**：基于官方文档的权威实现
- **未来兼容**：符合 PopClip 长期发展方向

### 🔄 与 v4.x 的区别

| 特性 | v4.x 版本 | v5.0 版本 |
|------|-----------|----------|
| 实现方式 | 非标准函数定义 | 官方标准顶层执行 |
| 数据获取 | 函数参数 | popclip 全局对象 |
| 兼容性策略 | 多重兼容尝试 | 单一标准实现 |
| 代码复杂度 | 复杂兼容性代码 | 简洁标准代码 |
| 问题解决 | 症状修复 | 根本性解决 |

---

## v4.4 (2025-08-28) - 终极稳定版本（已废弃）

### 🔧 修复内容
- **核心问题**：修复 JavaScript 函数与变量冲突错误
- **技术细节**：删除冲突的 `var action` 声明，避免覆盖 `function action`
- **兼容性**：提供最稳定的四重兼容性支持
- **稳定性**：解决所有已知的 "Can't find variable" 错误

## v4.2-v4.3 (2025-08-28) - 修复历程

### v4.2 修复内容
- **修复**: 彻底解决 "Can't find variable: action" 错误
- **改进**: 四重兼容性设计，支持所有已知 PopClip 版本
- **增强**: 智能环境检测和自动适配

### v4.3 修复内容
- **函数定义**：添加直接的 `function action()` 定义
- **兼容性**：五重兼容性设计（后发现存在冲突）

### 🔧 技术变更
```javascript
// 四重兼容性设计
function main(selection, settings) { /* 逻辑 */ }

// 1. 现代版本兼容
exports.action = main;

// 2. 传统版本兼容
if (typeof exports === 'undefined') {
    this.main = main;
}

// 3. action 变量兼容 (v4.2 新增)
var action = main;

// 4. 全局 action 兼容 (v4.2 新增)
if (typeof window !== 'undefined') {
    window.action = main;
} else if (typeof global !== 'undefined') {
    global.action = main;
} else {
    this.action = main;
}
```

### 📦 文件变更
- `action.js`: 添加 action 变量和全局函数支持
- `Config.json`: 更新标识符为 `cc.cubox.popclip.saver.v4.2`
- 新增: `修复 action 变量错误 - v4.2.md` 专项文档

### 🎯 解决的错误日志
```
[Cubox Saver v4.1] error: ReferenceError: Can't find variable: action
```

---

## v4.1 (2025-08-28) - 紧急修复版本

### 🚨 修复的关键问题
- **修复**: 彻底解决 "Can't find variable: main" 错误
- **修复**: PopClip 版本兼容性问题
- **改进**: 添加双重函数支持 (main + exports.action)

### 🔧 技术变更
```javascript
// 新增 main 函数定义
function main(selection, settings) {
    // 插件逻辑
}

// 保持 exports.action 兼容性
exports.action = main;

// 添加旧版本兼容性检测
if (typeof exports === 'undefined') {
    this.main = main;
}
```

### 📦 文件变更
- `action.js`: 重构为双重兼容性架构
- `Config.json`: 更新标识符为 `cc.cubox.popclip.saver.v4.1`
- 新增: `修复 main 变量错误 - v4.1.md` 专项故障排除文档

### 🎯 解决的错误日志
```
[Cubox Saver v3] error: ReferenceError: Can't find variable: main
```

### 📋 升级说明
1. **必须完全删除旧版本** (包括 v3, v4)
2. **重启 PopClip 应用**
3. 安装 v4.1 版本
4. 确认插件显示为 "Cubox Saver v4.1"

---

## v4.0 (之前版本)

### ✅ 已修复问题
- 修复 "Can't find variable: cubox" 错误
- 解决插件不显示问题
- 优化错误处理和用户反馈

### 🔧 技术改进
- 使用 `action.js` 避免文件名冲突
- 简化变量命名
- 新插件标识符 `cc.cubox.popclip.saver.v4`

---

## v3.x (已废弃)

### ❌ 已知问题
- "Can't find variable: cubox" 错误
- "Can't find variable: main" 错误
- 变量冲突导致插件无法正常工作

**注意**: v3.x 版本已废弃，请升级到 v4.1

---

## 兼容性说明

### PopClip 版本支持
- ✅ PopClip 2021.5 及更新版本 (推荐)
- ✅ PopClip 2020.x 版本 (通过 main 函数兼容)
- ❌ PopClip 2019.x 及更早版本 (不支持)

### macOS 版本支持
- ✅ macOS 12 Monterey 及更新版本
- ✅ macOS 11 Big Sur
- ✅ macOS 10.15 Catalina
- ⚠️ macOS 10.14 及更早版本 (未测试)

### 测试环境
- PopClip 2023.3.2
- macOS 13.6 Ventura
- Safari, TextEdit, Pages 应用

---

## 故障排除

如果升级后仍有问题，请参考：
- `修复 main 变量错误 - v4.1.md` - 专项故障排除
- `故障排除 - 图标不显示.md` - 通用故障排除
- `安装和使用指南.md` - 详细安装指南